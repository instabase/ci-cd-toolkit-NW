name: Build and Publish

on:
  pull_request:
    types:
      - closed
    branches:
      - main
    paths-ignore:
      - "README.md"
      - "Contributing.md"
      - ".github/**"
  workflow_dispatch:

permissions:
  contents: write
  id-token: write

jobs:
  build:
    name: Build and release distribution ðŸ“¦
    runs-on: ubuntu-latest
    if: github.event.pull_request.merged == true || github.event_name == 'workflow_dispatch'
    steps:
      - name: Check out code
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Set up Python
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065 # v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install pypa/build
        run: >-
          python3 -m
          pip install
          build
          --user

      - name: Build a binary wheel and a source tarball
        run: python3 -m build

      - name: Store the distribution packages
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        with:
          name: ib_cicd_dist
          path: dist/

      - name: Install package version reader
        # Installs dasel into the environment for clean parsing of the pyproject.toml configuration
        # Project lives at https://github.com/TomWright/dasel
        # Installation instructions that this is taken from
        # live at https://daseldocs.tomwright.me/installation#manual
        run: >-
          curl -sSLf
          "$(curl -sSLf https://api.github.com/repos/tomwright/dasel/releases/latest | grep browser_download_url | grep linux_amd64 | grep -v .gz | cut -d\" -f 4)"
          -L -o dasel
          && chmod +x dasel

      - name: Set package version
        # Get the Python package version from the pyproject.toml
        # and set it under python-package-version.PYTHON_PKG_VERSION for later use
        id: python-package-version
        run: >-
          echo
          "PYTHON_PKG_VERSION=$(cat pyproject.toml | ./dasel -r toml '.project.version' | tr -d "'")"
          >> "$GITHUB_OUTPUT"

      - name: Get package path
        # Get the path to the built .whl file
        # and set it under python-package-path.PYTHON_PKG_PATH for later use
        id: python-package-path
        run: >-
          echo
          "PYTHON_PKG_PATH=$(ls dist/*.whl)"
          >> "$GITHUB_OUTPUT"

      - name: Publish GitHub Release
        # Publish a GitHub release with the built .whl
        # using the version tag from pyproject.toml
        uses: softprops/action-gh-release@a06a81a03ee405af7f2048a818ed3f03bbf83c7b # v2
        env:
          PYTHON_PKG_VERSION: ${{ steps.python-package-version.outputs.PYTHON_PKG_VERSION }}
          PYTHON_PKG_PATH: ${{ steps.python-package-path.outputs.PYTHON_PKG_PATH }}
        with:
          tag_name: ${{ env.PYTHON_PKG_VERSION }}
          files: ${{ env.PYTHON_PKG_PATH }}
          fail_on_unmatched_files: true
          generate_release_notes: true
          make_latest: true

      - name: Publish Release to Secondary Repo
        # Publish a release to the secondary repository
        uses: softprops/action-gh-release@a06a81a03ee405af7f2048a818ed3f03bbf83c7b # v2
        env:
          PYTHON_PKG_VERSION: ${{ steps.python-package-version.outputs.PYTHON_PKG_VERSION }}
          PYTHON_PKG_PATH: ${{ steps.python-package-path.outputs.PYTHON_PKG_PATH }}
        with:
          repository: samyak-ib/ci-cd-test
          token: ${{ secrets.SAMYAK_JAIN_PERSONAL_ACCESS_TOKEN }}
          tag_name: ${{ env.PYTHON_PKG_VERSION }}
          files: ${{ env.PYTHON_PKG_PATH }}
          fail_on_unmatched_files: false
          make_latest: true