name: Weekly Regression Tests

on:
  schedule:
    - cron: '0 0 * * 0'  # Run at midnight every Sunday
  workflow_dispatch:  # Allow manual trigger

jobs:
  regression:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@f43a0e5ff2bd294095638e18286ca9a3d1956744 # v3

    - name: Set up Python
      uses: actions/setup-python@7f4fc3e22c37d6ff65e88745f38bd3157c663f7c # v4
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install tox

    - name: Run regression tests
      env:
        SOURCE_HOST_URL: "https://aihub.instabase.com"
        TARGET_HOST_URL: "https://aihub.eu.instabase.com"
        SOURCE_TOKEN: "gIfF8A7tqAaZOMOm2BgEWWiLCaT0h9"
        TARGET_TOKEN: "dbRMJz0Q7nwW1xHxG8Ne9qr9CJTqbI"
      run: |
        tox -e regression

    - name: Create issue on failure
      if: failure()
      uses: actions/github-script@00f12e3e20659f42342b1c0226afda7f7c042325 # v6
      with:
        script: |
          const issue = await github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: 'ðŸš¨ Weekly Regression Test Failed',
            body: 'The weekly regression test suite has failed. Please check the logs for details.'
          });
